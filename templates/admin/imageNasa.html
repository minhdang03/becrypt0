{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">Quản lý hình ảnh Slideshow</h1>
    
    <a href="{{ url_for('slideshow.add_nasa_images') }}" class="btn btn-primary mt-3">Thêm hình ảnh từ NASA</a>
    <p></p>
    <div class="table-responsive">
        <table class="table table-bordered table-hover">
            <thead class="thead-light">
                <tr>
                    <th style="width: 15%;">Hình ảnh</th>
                    <th>Tên</th>
                    <th style="width: 10%;">Hành động</th>
                </tr>
            </thead>
            <tbody id="image-list">
                <!-- Hình ảnh sẽ được thêm vào đây bằng JavaScript -->
            </tbody>
        </table>
    </div>

    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center" id="pagination">
            <!-- Các nút phân trang sẽ được thêm vào đây bằng JavaScript -->
        </ul>
    </nav>

</div>

<script>
let currentPage = {{ current_page }};
let perPage = {{ per_page }};
let totalPages = 0;

function loadImages(page) {
    fetch(`/slideshow/get_images?page=${page}&per_page=${perPage}`)
        .then(response => response.json())
        .then(data => {
            displayImages(data.images);
            totalPages = data.total_pages;
            updatePagination(data.current_page);
        })
        .catch(error => console.error('Error fetching images:', error));
}

function displayImages(images) {
    const imageList = document.getElementById('image-list');
    imageList.innerHTML = '';
    images.forEach(image => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="text-center">
                <img src="{{ url_for('static', filename='img/slideshow/') }}${image}" alt="${image}" class="img-fluid" style="max-height: 100px;">
            </td>
            <td class="align-middle">${image.replace('_', ' ').replace('.png', '')}</td>
            <td class="text-center align-middle">
                <button class="btn btn-danger btn-sm delete-image" data-image="${image}">Xóa</button>
            </td>
        `;
        imageList.appendChild(row);
    });
    setupDeleteButtons();
}

function updatePagination(currentPage) {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
        pagination.appendChild(li);
    }
    pagination.addEventListener('click', handlePaginationClick);
}

function handlePaginationClick(event) {
    event.preventDefault();
    if (event.target.tagName === 'A') {
        const page = parseInt(event.target.dataset.page);
        if (page !== currentPage) {
            currentPage = page;
            loadImages(currentPage);
        }
    }
}

function setupDeleteButtons() {
    document.querySelectorAll('.delete-image').forEach(button => {
        button.addEventListener('click', function() {
            const imageName = this.dataset.image;
            if (confirm(`Bạn có chắc chắn muốn xóa hình ảnh "${imageName}"?`)) {
                deleteImage(imageName);
            }
        });
    });
}

function deleteImage(imageName) {
    fetch('/slideshow/delete_image', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ image: imageName }),
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        loadImages(currentPage);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Có lỗi xảy ra khi xóa hình ảnh');
    });
}

// Tải hình ảnh ban đầu
loadImages(currentPage);
</script>
{% endblock %}