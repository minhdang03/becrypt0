{% extends "layout.html" %}

{% block title %}
    {% if blog %}
        Sửa bài viết
    {% else %}
        Thêm Blog Mới
    {% endif %}
{% endblock %}

{% block extra_head %}
{{ super() }}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
    #editor {
        font-family: Arial, sans-serif;
        font-size: 18px; /* Increase default text size */
        line-height: 1.6;
        padding: 20px;
        background-color: white;
        min-height: 300px;
    }
    #editor h1, #editor h2, #editor h3 {
        margin-top: 20px;
        margin-bottom: 10px;
    }
    #editor p {
        margin-bottom: 15px;
    }
    #editor img {
        max-width: 100%; /* Đặt kích thước tối đa cho hình ảnh */
        height: auto; /* Giữ tỷ lệ khung hình */
    }
    .ql-toolbar .ql-formats {
        display: flex;
        flex-wrap: wrap;
    }
    .ql-toolbar button {
        font-size: 20px; /* Increase icon size */
    }
    .ql-toolbar .ql-align {
        width: auto;
    }
    .ql-toolbar .ql-align .ql-picker-label {
        display: none;
    }
    .ql-toolbar .ql-align .ql-picker-item {
        display: inline-block;
        width: auto;
        padding: 0 10px;
    }

    .fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 9999;
        background: white;
    
    
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto mt-20 px-4"> <!-- Thêm padding-top và padding-x -->
    {% include 'slideshow.html' %}
    <div class="overflow-hidden">
        <div class="bg-white p-4 rounded-lg shadow"> <!-- Thêm padding và style -->
            <form method="POST" enctype="multipart/form-data">
                {{ form.hidden_tag() }}
                <div class="mb-6">
                    <label for="{{ form.title.id }}" class="block text-gray-700 font-bold mb-2"></label>
                    {{ form.title(class="form-input mt-1 block w-full rounded-lg text-lg p-4 border-gray-300 focus:outline-none focus:ring-0 focus:border-gray-300", placeholder="Nhập tiêu đề bài viết") }}
                </div>

                <div class="mb-6">
                    <label for="{{ form.category_id.id }}" class="block text-gray-700 font-bold mb-2"></label>
                    {{ form.category_id(class="form-select mt-1 block w-full border-gray-300 rounded-lg text-lg shadow-sm focus:ring focus:ring-blue-200 focus:ring-opacity-50") }}
                </div>
                <div class="mb-6">
                    <label for="editor" class="block text-gray-700 font-bold mb-2"></label>
                    <div id="editor" class="border border-gray-300 rounded-lg shadow-sm" style="height: 300px;"></div>
                    <input type="hidden" name="content" id="content">
                    <input type="hidden" id="blog-content" value="{{ blog.content|e if blog else '' }}">
                </div>
                <input type="file" id="image-upload" accept="image/*" class="hidden" multiple>
                <div class="mt-6 flex justify-between">
                    <a href="{{ url_for('blogs.blog_list') }}" class="bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors"><i class="fas fa-times"></i> Hủy</a>
                    <button type="button" id="save-draft" class="bg-yellow-500 text-white py-2 px-4 rounded-lg hover:bg-yellow-600 transition-colors"><i class="fas fa-save"></i> Lưu nháp</button>
                    <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-paper-plane"></i>
                        {% if blog %}
                            Sửa bài
                        {% else %}
                            Đăng bài
                        {% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    ['blockquote', 'code-block'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'script': 'sub'}, { 'script': 'super' }],
                    // [{ 'indent': '-1'}, { 'indent': '+1' }],
                    [{ 'direction': 'rtl' }],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'font': [] }],
                    [{ 'align': '' }, { 'align': 'center' }, { 'align': 'right' }, { 'align': 'justify' }],  // Hiển thị các tùy chọn căn chỉnh luôn
                    ['clean'],
                    ['link', 'image'],
                    [{ 'size': ['small', false, 'large', 'huge'] }], // Thêm tùy chọn kích thước chữ
                ]
            }
        });

        // Kiểm tra xem phần tử có tồn tại không
        var contentElement = document.getElementById('blog-content');
        if (contentElement) {
            var content = contentElement.value;
            var parser = new DOMParser();
            var doc = parser.parseFromString(content, 'text/html');
            var images = doc.querySelectorAll('img');
            images.forEach(img => {
                var src = img.getAttribute('src');
                if (src && src.startsWith('/blogs_user/edit/')) {
                    // Loại bỏ phần tiền tố dư thừa
                    src = src.replace('/blogs_user/edit/', '/');
                }
                // Thêm tiền tố từ tên miền đã định nghĩa trong .env
                if (src && !src.startsWith('http')) {
                    src = `${location.origin}/${src}`;
                }
                img.setAttribute('src', src);
            });
            quill.clipboard.dangerouslyPasteHTML(doc.body.innerHTML);
        } else {
            console.warn('Không tìm thấy phần tử có id "blog-content"');
        }

        quill.getModule('toolbar').addHandler('image', function() {
            document.getElementById('image-upload').click();
        });

        document.getElementById('image-upload').addEventListener('change', function() {
            var files = this.files;
            if (files.length > 0) {
                var formData = new FormData();
                for (var i = 0; i < files.length; i++) {
                    formData.append('images', files[i]);
                }

                fetch('/blogs_user/user_upload_image', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.urls) {
                        data.urls.forEach(url => {
                            var range = quill.getSelection();
                            quill.insertEmbed(range.index, 'image', url);
                            // Đặt kích thước hình ảnh
                            var img = quill.container.querySelector(`img[src="${url}"]`);
                            if (img) {
                                img.style.maxWidth = '50%';
                                img.style.height = 'auto';
                            }
                        });
                    } else {
                        console.error('Failed to upload image:', data.error);
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        });

        quill.clipboard.addMatcher(Node.ELEMENT_NODE, function(node, delta) {
            if (node.tagName === 'IMG') {
                delta.ops = [{
                    insert: {
                        image: node.src
                    }
                }];
            }
            return delta;
        });

        // Xử lý việc submit form
        document.querySelector('form').onsubmit = function(e) {
            e.preventDefault();
            var content = document.querySelector('#content');
            content.value = quill.root.innerHTML;
            console.log("Form submitted, content:", content.value);
            this.submit();
        };

        // Save Draft button functionality
        document.getElementById('save-draft').addEventListener('click', function() {
            var content = document.querySelector('#content');
            content.value = quill.root.innerHTML;
            console.log("Draft saved, content:", content.value);
            // Implement your save draft functionality here
        });

        // Fullscreen mode toggle
        var isFullscreen = false;
        var editorContainer = document.querySelector('.container');
        var fullscreenButton = document.createElement('button');
        fullscreenButton.innerHTML = '<i class="fas fa-expand"></i> Fullscreen';
        fullscreenButton.className = 'bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors';
        fullscreenButton.style.position = 'absolute';
        fullscreenButton.style.top = '10px';
        fullscreenButton.style.right = '10px';
        document.body.appendChild(fullscreenButton);

        fullscreenButton.addEventListener('click', function() {
            if (isFullscreen) {
                editorContainer.classList.remove('fullscreen');
                fullscreenButton.innerHTML = '<i class="fas fa-expand"></i> Fullscreen';
            } else {
                editorContainer.classList.add('fullscreen');
                fullscreenButton.innerHTML = '<i class="fas fa-compress"></i> Exit Fullscreen';
            }
            isFullscreen = !isFullscreen;
        });

        // Markdown support
        var markdownButton = document.createElement('button');
        markdownButton.innerHTML = '<i class="fas fa-code"></i> Markdown';
        markdownButton.className = 'bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors';
        markdownButton.style.position = 'absolute';
        markdownButton.style.top = '10px';
        markdownButton.style.right = '150px';
        document.body.appendChild(markdownButton);

        markdownButton.addEventListener('click', function() {
            var markdownContent = prompt('Enter Markdown content:');
            if (markdownContent) {
                var htmlContent = marked(markdownContent);
                quill.clipboard.dangerouslyPasteHTML(htmlContent);
            }
        });
    });
</script>
{% endblock %}